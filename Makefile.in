# The top-level Makefile that is used to build 

# State the platforms for which we are building
BUILD_FOR_PYTHON=@BUILD_FOR_PYTHON@

VERSION = @VERSION@

SUBDIRS := c
ifeq ($(BUILD_FOR_PYTHON),yes)
SUBDIRS += python
endif
SUBDIRS += tests

ifdef PRINT_DIRECTORIES
MAKE_CMD = $(MAKE) -j -l 5.0 
MAKE_DIR = $(MAKE_CMD) -C $(dir)
else
MAKE_CMD = $(MAKE) -j -l 5.0 --no-print-directory -s 
MAKE_DIR = $(MAKE_CMD) -C $(dir)
endif

LIBS_DIR = @RDFADIR@/libs

.PHONY: all verbose clean test docs

all: docs
	@$(foreach dir,$(SUBDIRS),$(MAKE_DIR) build-objects build-libraries &&) true
	@$(foreach dir,$(SUBDIRS),$(MAKE_DIR) build-executables &&) true

clean:
	@$(foreach dir,$(SUBDIRS),MAKE_CLEAN_ACTIVE=true $(MAKE_DIR) clean &&) true
	@rm -rf libs/*
	@echo "Removed all objects and libraries."

tests: all
	LD_LIBRARY_PATH=@RDFADIR@/libs tests/dist/curies
	LD_LIBRARY_PATH=@RDFADIR@/libs tests/dist/rdfa2n3 tests/testsuite/0001.xhtml

docs:
	@$(MAKE_DIR) docs

install-librdfa:
	install -d $(PREFIX)/usr/lib/
	install -m 644 $(LIBS_DIR)/librdfa.so $(PREFIX)/usr/lib/librdfa.so.$(VERSION)
	ln -s librdfa.so.$(VERSION) $(PREFIX)/usr/lib/librdfa.so

install-librdfa-dev:
	install -d $(PREFIX)/usr/lib/
	install -d $(PREFIX)/usr/include/
	install -m 644 $(LIBS_DIR)/librdfa.a $(PREFIX)/usr/lib/librdfa.a
	install -m 644 $(LIBS_DIR)/librdfa.so $(PREFIX)/usr/lib/librdfa.so.$(VERSION)
	ln -s librdfa.so.$(VERSION) $(PREFIX)/usr/lib/librdfa.so
	install -m 644 c/rdfa.h $(PREFIX)/usr/include/
	install -m 644 c/rdfa_utils.h $(PREFIX)/usr/include/

ifeq ($(BUILD_FOR_PYTHON),yes)
install-python:
	install -d $(PREFIX)/usr/lib/python$(PYVER)/site-packages
	install -m 644 python/dist/rdfa.py $(PREFIX)/usr/lib/python$(PYVER)/site-packages
	install -m 644 python/dist/python$(PYVER)-rdfa.so $(PREFIX)/usr/lib/python$(PYVER)/site-packages/_rdfa.so
else
install-python:
endif

packages: all
	mkdir -p installers/packages
	dpkg-buildpackage -us -uc -rfakeroot
	mv ../*rdfa*$(RELEASE)*deb installers/packages
	cd installers/packages && fakeroot alien --to-rpm -k *deb
	cd installers/packages && fakeroot alien --to-tgz -k *deb
	cd installers/packages && fakeroot alien --to-pkg -k *deb
	cd installers/packages && fakeroot alien --to-slp -k *deb

install: install-librdfa install-librdfa-dev install-python

verbose:
	PRINT_DIRECTORIES=true $(MAKE) all
